{
  "id": "EPIC-12",
  "title": "AI Chat with Project Data",
  "description": "AI-powered chat interface that allows users to query their project data using natural language. Uses Pydantic AI with Gemini function calling to execute safe, parameterized queries against structured project data (equipment, materials, RFIs, inspections, meetings, approvals, areas) and search through analyzed documents.",
  "status": "in_progress",
  "priority": "high",
  "stories": [
    {
      "id": "STORY-12-1",
      "title": "Backend Chat Models & Database Schema",
      "description": "Create chat_conversations and chat_messages DB tables with Alembic migration. Conversations are scoped to project_id + user_id. Messages store role, content, tool_calls (JSONB), and tool_results (JSONB) for full audit trail.",
      "status": "done",
      "acceptance_criteria": [
        "ChatConversation model with project_id, user_id, title, timestamps",
        "ChatMessage model with conversation_id, role, content, tool_calls JSONB, tool_results JSONB",
        "Alembic migration 010 creates both tables with proper indexes and foreign keys",
        "Models registered in __init__.py"
      ]
    },
    {
      "id": "STORY-12-2",
      "title": "Chat Query Tools (13 tools)",
      "description": "Implement 13 async query functions that retrieve project data from the database. Each tool takes (db, project_id, **kwargs) and returns a dict. Tools: get_project_summary, count_equipment_by_status, list_equipment, count_materials_by_status, list_materials, count_rfis_by_status, list_rfis, count_inspections_by_status, list_inspections, get_meetings, get_approval_queue, get_area_progress, search_documents.",
      "status": "done",
      "acceptance_criteria": [
        "All 13 tools execute parameterized SQL queries (no raw SQL injection)",
        "project_id is always injected server-side, never from LLM",
        "Tools support relevant filters (status, type, priority, category)",
        "Results are limited (max 50 items) to prevent token overflow",
        "search_documents uses ILIKE on JSONB cast for full-text search"
      ]
    },
    {
      "id": "STORY-12-3",
      "title": "Pydantic AI Chat Service (Gemini Orchestrator)",
      "description": "Orchestrator that uses Pydantic AI Agent with Gemini 2.0 Flash and function calling. Manages conversation history serialization/deserialization, tool registration via @agent.tool decorators, and message persistence to DB.",
      "status": "done",
      "acceptance_criteria": [
        "Agent uses google-gla provider with Gemini API key from settings",
        "13 tools registered with descriptive docstrings for LLM",
        "Conversation history loaded from DB and passed via message_history",
        "System prompt instructs multi-language responses and tool-first behavior",
        "Messages serialized via pydantic_core.to_jsonable_python for DB storage"
      ]
    },
    {
      "id": "STORY-12-4",
      "title": "Chat API Endpoints",
      "description": "REST API endpoints for chat: POST send message, GET list conversations, GET conversation detail, DELETE conversation. All endpoints verify project access via existing auth middleware.",
      "status": "done",
      "acceptance_criteria": [
        "POST /projects/{project_id}/chat sends message and returns user+assistant messages",
        "GET /projects/{project_id}/chat/conversations lists user's conversations with message_count",
        "GET /projects/{project_id}/chat/conversations/{id} returns full message history",
        "DELETE /projects/{project_id}/chat/conversations/{id} deletes conversation",
        "All endpoints require auth and project access verification"
      ]
    },
    {
      "id": "STORY-12-5",
      "title": "Frontend Chat UI Components",
      "description": "Chat drawer UI with FAB trigger button, message bubbles, input field, suggestion chips, and conversation history management. Integrated into the main Layout component.",
      "status": "done",
      "acceptance_criteria": [
        "FAB button (bottom-right) visible when a project is selected",
        "Right-side drawer (420px) with chat interface",
        "User messages (right, primary color) and assistant messages (left, with AI icon)",
        "Enter to send, Shift+Enter for newline, loading indicator",
        "Quick suggestion chips for common queries",
        "Conversation history list with load/delete",
        "i18n translations for EN, HE, ES"
      ]
    },
    {
      "id": "STORY-12-6",
      "title": "WhatsApp Integration (Phase 2 - Future)",
      "description": "Add WhatsApp webhook endpoint to allow users to chat with project data via WhatsApp. Requires Twilio/Meta API credentials.",
      "status": "planned",
      "acceptance_criteria": [
        "WhatsApp webhook endpoint receives messages",
        "User identified by phone number mapping",
        "Reuses same chat_service.send_message orchestrator",
        "Outbound messages sent via WhatsApp Business API"
      ]
    }
  ]
}
