# Specification: Create Alembic Migration for Inspections

## Overview

Create a database migration using Alembic to add four new tables for the inspection management system: inspection_consultant_types, inspection_stage_templates, project_inspections, and inspection_findings. This migration establishes the schema foundation for tracking project inspections, including consultant types, stage templates, inspection records, and individual findings.

## Workflow Type

**Type**: feature

**Rationale**: This task introduces new database schema to support inspection management functionality. It's a feature migration that creates foundational tables with relationships and indexes to enable efficient querying of inspection data.

## Task Scope

### Services Involved
- **backend** (primary) - Database schema creation via Alembic migration

### This Task Will:
- [ ] Create `inspection_consultant_types` table for consultant type lookup
- [ ] Create `inspection_stage_templates` table for stage definitions with indexes on `consultant_type_id` and `stage_order`
- [ ] Create `project_inspections` table for inspection records with indexes on `project_id`, `stage_template_id`, `status`, and `scheduled_date`
- [ ] Create `inspection_findings` table for individual findings with indexes on `inspection_id` and `finding_type`
- [ ] Establish foreign key relationships between tables
- [ ] Generate migration file using Alembic autogenerate

### Out of Scope:
- API endpoints for inspection management (future work)
- Frontend UI for inspections (future work)
- SQLAlchemy model definitions (must exist before migration)
- Data seeding or initial consultant type records

## Service Context

### Backend

**Tech Stack:**
- Language: Python
- Framework: FastAPI
- ORM: SQLAlchemy
- Database: PostgreSQL (via psycopg2-binary)
- Migration Tool: Alembic

**Entry Point:** `app/main.py`

**How to Run:**
```bash
# From backend directory
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

**Port:** 8000

**Migration Configuration:**
- Directory: `alembic/versions`
- Config File: `alembic.ini`

**Key Commands:**
```bash
# Create new migration (autogenerate)
alembic revision --autogenerate -m "add inspection templates"

# Apply migration
alembic upgrade head

# Rollback migration
alembic downgrade -1
```

## Files to Modify

| File | Service | What to Change |
|------|---------|---------------|
| N/A - Migration will be auto-generated | backend | Alembic will create new migration file in `alembic/versions/` |

## Files to Reference

These files show patterns to follow:

| File | Pattern to Copy |
|------|----------------|
| `backend/alembic/versions/*` | Existing migration file structure and naming conventions |
| `backend/app/models/*.py` | SQLAlchemy model patterns for table definitions |
| `backend/alembic.ini` | Migration configuration settings |

## Patterns to Follow

### Database Table Naming Convention

Tables should use lowercase with underscores (snake_case):
- `inspection_consultant_types`
- `inspection_stage_templates`
- `project_inspections`
- `inspection_findings`

**Key Points:**
- Use descriptive, plural table names
- Foreign key columns follow `[table_singular]_id` pattern
- Index names auto-generated by Alembic or explicitly named

### Foreign Key Relationships

Expected relationships:
```python
# inspection_stage_templates references inspection_consultant_types
consultant_type_id -> inspection_consultant_types.id

# project_inspections references multiple tables
project_id -> projects.id
stage_template_id -> inspection_stage_templates.id

# inspection_findings references project_inspections
inspection_id -> project_inspections.id
```

**Key Points:**
- Use `ondelete` rules appropriate for each relationship
- Consider CASCADE vs RESTRICT based on business logic
- Ensure referential integrity is enforced at database level

### Index Strategy

From requirements, these indexes are critical for query performance:

**inspection_stage_templates:**
- `consultant_type_id` - For filtering templates by consultant type
- `stage_order` - For ordering stages in sequence

**project_inspections:**
- `project_id` - For retrieving all inspections for a project
- `stage_template_id` - For finding inspections using a specific template
- `status` - For filtering inspections by status (pending, completed, etc.)
- `scheduled_date` - For time-based queries and calendar views

**inspection_findings:**
- `inspection_id` - For retrieving all findings for an inspection
- `finding_type` - For categorizing and filtering findings

## Requirements

### Functional Requirements

1. **Create inspection_consultant_types table**
   - Description: Lookup table for different types of consultants (structural, electrical, etc.)
   - Acceptance: Table exists with appropriate columns (id, name, description, created_at, updated_at)

2. **Create inspection_stage_templates table**
   - Description: Template definitions for inspection stages linked to consultant types
   - Acceptance: Table exists with foreign key to consultant_types and indexes on consultant_type_id and stage_order

3. **Create project_inspections table**
   - Description: Main inspection records associated with projects
   - Acceptance: Table exists with foreign keys to projects and stage_templates, plus indexes on project_id, stage_template_id, status, and scheduled_date

4. **Create inspection_findings table**
   - Description: Individual findings/issues discovered during inspections
   - Acceptance: Table exists with foreign key to inspections and indexes on inspection_id and finding_type

5. **Migration reversibility**
   - Description: Migration can be rolled back cleanly
   - Acceptance: `alembic downgrade -1` successfully removes all four tables

### Edge Cases

1. **Foreign key constraint violations** - Ensure projects table exists before applying migration; migration should fail gracefully if referenced tables don't exist
2. **Index naming conflicts** - Use Alembic's auto-generated index names or check for naming collisions with existing indexes
3. **Nullable vs non-nullable fields** - Carefully consider which fields should allow NULL (e.g., scheduled_date might be null initially, but status should have a default)
4. **Cascade deletes** - Decide whether deleting a project/template/inspection should cascade to dependent records or restrict deletion

## Implementation Notes

### DO
- First verify SQLAlchemy models exist for all four tables in `app/models/`
- Run `alembic revision --autogenerate -m "add inspection templates"` from the backend directory
- Review the generated migration file before applying it
- Check that all foreign key constraints are properly defined
- Verify all required indexes are present in the generated migration
- Test both upgrade and downgrade operations in development environment
- Ensure column types are appropriate (UUIDs for IDs, VARCHAR for strings, TIMESTAMP for dates)

### DON'T
- Don't manually write the migration file when autogenerate can handle it
- Don't skip reviewing the auto-generated migration - Alembic sometimes misses relationships
- Don't apply the migration to production without testing rollback first
- Don't forget to add the migration file to version control
- Don't assume default index names - verify they're readable and descriptive

## Development Environment

### Start Services

```bash
# Start PostgreSQL database via Docker
cd /Users/galhadida/projects/builder_project/builder_program
docker-compose up db -d

# Start backend (from backend directory)
cd backend
pip install -r requirements.txt
uvicorn app.main:app --reload --port 8000
```

### Service URLs
- Backend API: http://localhost:8000
- API Docs: http://localhost:8000/docs
- PostgreSQL: localhost:5432

### Required Environment Variables
- `DATABASE_URL`: PostgreSQL connection string (check `.env` or `docker-compose.yml`)

## Success Criteria

The task is complete when:

1. [ ] All four tables (inspection_consultant_types, inspection_stage_templates, project_inspections, inspection_findings) exist in the database
2. [ ] All required indexes are present and correctly defined
3. [ ] Foreign key relationships are established between tables
4. [ ] Migration file is generated in `alembic/versions/` directory
5. [ ] Migration can be applied successfully with `alembic upgrade head`
6. [ ] Migration can be rolled back successfully with `alembic downgrade -1`
7. [ ] No console errors or warnings during migration
8. [ ] Migration file is committed to version control

## QA Acceptance Criteria

**CRITICAL**: These criteria must be verified by the QA Agent before sign-off.

### Unit Tests
| Test | File | What to Verify |
|------|------|----------------|
| Migration file syntax | `alembic/versions/[revision]_add_inspection_templates.py` | Valid Python syntax, no errors |
| Model definitions exist | `app/models/*.py` | All four models defined with proper SQLAlchemy syntax |

### Integration Tests
| Test | Services | What to Verify |
|------|----------|----------------|
| Foreign key integrity | backend ↔ database | FK constraints prevent orphaned records |
| Index creation | backend ↔ database | All indexes exist and can be used by query planner |
| Migration reversibility | backend ↔ database | Downgrade removes all tables cleanly |

### End-to-End Tests
| Flow | Steps | Expected Outcome |
|------|-------|------------------|
| Apply migration | 1. Run `alembic upgrade head` 2. Check database schema | All four tables created with correct columns and indexes |
| Rollback migration | 1. Run `alembic downgrade -1` 2. Check database schema | All four tables removed, database state restored |

### Database Verification
| Check | Query/Command | Expected |
|-------|---------------|----------|
| Tables exist | `\dt inspection*` in psql | Four tables listed: inspection_consultant_types, inspection_stage_templates, project_inspections, inspection_findings |
| Indexes on inspection_stage_templates | `\d inspection_stage_templates` | Indexes on consultant_type_id and stage_order |
| Indexes on project_inspections | `\d project_inspections` | Indexes on project_id, stage_template_id, status, scheduled_date |
| Indexes on inspection_findings | `\d inspection_findings` | Indexes on inspection_id and finding_type |
| Foreign keys | `\d+ [table_name]` | FK constraints to referenced tables |
| Migration revision | `alembic current` | Shows the new migration revision |

### QA Sign-off Requirements
- [ ] Migration file generated with correct naming: `[revision]_add_inspection_templates.py`
- [ ] All four tables exist in database after upgrade
- [ ] All specified indexes exist and are queryable
- [ ] Foreign key constraints are enforced (test with insert violations)
- [ ] Migration rollback successfully removes all tables
- [ ] No SQL errors in migration up/down operations
- [ ] SQLAlchemy models match database schema
- [ ] Column types are appropriate (UUIDs, VARCHAR, TIMESTAMP, etc.)
- [ ] No regressions in existing migrations or database state
- [ ] Migration file follows existing project conventions
