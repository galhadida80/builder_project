{
  "task_description": "# Write RFI System Integration Tests\n\n**Linear Issue:** [BUI-109](https://linear.app/builder-project/issue/BUI-109/write-rfi-system-integration-tests)\n**Priority:** No priority\n**Status:** Backlog\n\n\n## Description\n\nAs a developer, I need integration tests for the RFI system so that I can ensure it works correctly.\n\n## Acceptance Criteria\n\n- [ ] Test RFI CRUD operations\n- [ ] Test RFI number generation (uniqueness)\n- [ ] Test email sending (mock Gmail API)\n- [ ] Test webhook processing (mock Pub/Sub)\n- [ ] Test email parsing with sample emails\n- [ ] Test RFI matching logic (thread_id, subject, In-Reply-To)\n- [ ] Test status transitions\n- [ ] Test notification triggers\n- [ ] Add fixtures for test data\n\n## Labels\n\nbackend, testing, rfi\n",
  "scoped_services": ["backend"],
  "files_to_modify": {
    "backend": [
      "tests/conftest.py",
      "requirements.txt"
    ]
  },
  "files_to_create": {
    "backend": [
      "tests/integration/test_rfi_system.py"
    ]
  },
  "files_to_reference": [
    "backend/tests/conftest.py",
    "backend/tests/integration/test_equipment_approval.py",
    "backend/app/models/rfi.py",
    "backend/app/api/v1/rfis.py",
    "backend/app/services/rfi_service.py",
    "backend/app/services/rfi_email_parser.py"
  ],
  "patterns": {
    "test_fixture_pattern": "Use AsyncClient with ASGITransport and dependency overrides. Function-scoped fixtures with cleanup.",
    "integration_test_pattern": "Group tests in classes with @pytest.mark.integration. Follow Arrange-Act-Assert pattern.",
    "async_testing": "Use pytest-asyncio with async test functions and AsyncClient for FastAPI endpoints.",
    "mocking_pattern": "Use unittest.mock.patch or pytest-mock for external services (Gmail API, Pub/Sub)."
  },
  "existing_implementations": {
    "description": "RFI system already exists with models, API endpoints, and services for email integration",
    "relevant_files": [
      "backend/app/models/rfi.py - RFI, RFIResponse, RFIEmailLog models with status enums",
      "backend/app/api/v1/rfis.py - CRUD endpoints for RFI management",
      "backend/app/services/rfi_service.py - Business logic including send_rfi and status transitions",
      "backend/app/services/rfi_email_parser.py - Email parsing with RFI number extraction"
    ],
    "rfi_status_transitions": [
      "draft → open (when RFI sent)",
      "open → waiting_response (after email sent)",
      "waiting_response → answered (response received)",
      "answered → closed (RFI resolved)",
      "any → cancelled (explicit cancellation)"
    ],
    "rfi_matching_logic": [
      "1. Primary: Match by email_thread_id",
      "2. Fallback 1: Extract RFI number from subject using regex",
      "3. Fallback 2: Match In-Reply-To header against email_message_id",
      "4. Unmatched: Log to RFIEmailLog with event_type='unmatched'"
    ]
  },
  "created_at": "2026-02-02T12:38:17.663850"
}
